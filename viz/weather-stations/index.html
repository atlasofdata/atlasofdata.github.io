<!DOCTYPE html>
<meta charset="utf-8">
<title>World Weather Stations</title>
<body>
  <div id="container"></div>
  <script src="https://unpkg.com/d3@5.9.2/dist/d3.min.js" charset="utf-8"></script>
  <script src="https://unpkg.com/d3-delaunay@4.1.5/dist/d3-delaunay.min.js" charset="utf-8"></script>
  <script src="https://unpkg.com/d3-geo-voronoi@1.1.2/build/d3-geo-voronoi.min.js" charset="utf-8"></script>
  <script>

    const height = 360;
    const width = 800;

    const canvas = d3.select('#container')
      .append('canvas')
      .attr('width', width)
      .attr('height', height);

    const context =  canvas.node().getContext('2d');

    d3.json('https://gist.githubusercontent.com/clemsos/fa07391890693a385c02b81b22828e7c/raw/23564ac68d9a23942e6ea7607b116fd02ca2a381/stations_clusters_1.json')
      .then(data => start(data))
      .catch(err => console.log(err))


    function start(stations) {

      // colors
      const counts = stations.map( d => d.count)
      const domain = [d3.max(counts), d3.min(counts)]

      let colorScale = d3.scaleSequential()
        .domain(domain)
        .interpolator(d3.interpolatePuBu)

      const points = stations.map((d,i) => [d.coords[0], d.coords[1],  colorScale(d.count)])
      const voronoi = d3.geoVoronoi(points);

      const polygons  = {
        type: "FeatureCollection",
        features: voronoi.polygons().features
      }

      const projection = d3.geoAzimuthalEqualArea()
        .rotate([0, -90])
        .translate([width / 2, height / 2])
        .fitExtent([[1, 1], [width - 1, height - 1]], {type: "Sphere"})
        .precision(0.1)

      // rotate earth

      function rotate () {
        console.log("rotate")

        const speed = 10;
        const rotation = speed ? (Date.now() / (201-speed) ) : projection.rotate()[0]

        console.log
        projection
          .rotate([rotation, projection.rotate()[1]]);

        const path = d3.geoPath(projection, context).pointRadius(1);

        // d3.select('canvas').selectAll('*').remove();

        polygons.features.forEach((p, i) => {
          context.beginPath();
          path(p);
          context.strokeStyle = context.fillStyle = points[i][2];
          context.lineWidth = .5;
          context.fill();
          context.stroke();
        });

      }
      setInterval(rotate,50)
    }
  </script>
</body>
